#include "function_placehearts.h"

static const uint8_t placehearts_minimal[] ICACHE_RODATA_ATTR = {
	0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94,
	0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xb8, 0xb8, 0xb8, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14,
	0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14,
	0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14,
	0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14,
	0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14,
	0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14,
	0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94,
	0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94,
	0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00,
	0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00,
	0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0xb8, 0xb8, 0xb8, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00,
	0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0xe8, 0x00, 0x14, 0xe8, 0x00, 0x14, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94,
	0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94,
	0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94, 0xb8, 0x78, 0x94
};

// Get color channel for pixel at (x, y): 0 <= x < 12, 0 <= y < 17
// color = 0, 1, 2 for R, G, B
uint8_t placehearts_getbyte(uint8_t x, uint8_t y, uint8_t color) {
	if (x >= 12 || y >= 17 || color >= 3)
		return 0x00;

	uint32_t res;
	const uint8_t *addr = &placehearts_minimal[(y * 12 + x) * 3 + color];

	// Source: https://github.com/esp8266/Arduino/blob/master/cores/esp8266/pgmspace.h
	asm(	"extui	%0, %1, 0, 2\n"		/* Extract offset within word (in bytes) */ \
		"sub	%1, %1, %0\n"		/* Subtract offset from addr, yielding an aligned address */ \
		"l32i.n	%1, %1, 0x0\n"		/* Load word from aligned address */ \
		"slli	%0, %0, 3\n"		/* Mulitiply offset by 8, yielding an offset in bits */ \
		"ssr	%0\n"			/* Prepare to shift by offset (in bits) */ \
		"srl	%0, %1\n"		/* Shift right; now the requested byte is the first one */ \
		:"=r"(res), "=r"(addr) \
		:"1"(addr) \
	:);

	return (uint8_t) res;
}

void function_placehearts(int32_t xpos, uint8_t ypos, uint32_t millis, Color *rgb) {
	uint32_t y = ypos + millis / 100;
	uint32_t x = xpos % 12;
	y = y % 17;
	rgb->r = placehearts_getbyte(x, y, 0);
	rgb->g = placehearts_getbyte(x, y, 1);
	rgb->b = placehearts_getbyte(x, y, 2);
}
